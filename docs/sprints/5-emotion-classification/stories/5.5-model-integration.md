# Story 5.5: Model Integration

**Status:** To Do
**Assignee:** U2 (Anton Shkrebela)
**Priority:** Medium
**Sprint:** 5 - Emotion Classification

---

## Description

As a developer, I want to integrate the emotion model into the codebase.

---

## Acceptance Criteria

- [ ] EmotionModel class implemented
- [ ] DogFACS labels included
- [ ] Unit tests written
- [ ] Documentation updated

---

## Tasks

- [ ] Create EmotionModel class
- [ ] Load trained MLP weights
- [ ] Implement prediction from keypoints
- [ ] Write unit tests
- [ ] Add docstrings

---

## Implementation

```python
# packages/models/emotion.py

from dataclasses import dataclass
import torch
import numpy as np

EMOTION_LABELS = {
    0: "happy",
    1: "sad",
    2: "angry",
    3: "fearful",
    4: "relaxed",
    5: "neutral"
}

@dataclass
class EmotionPrediction:
    class_id: int
    class_name: str
    confidence: float
    all_probs: dict[str, float]

class EmotionModel:
    def __init__(self, weights_path: str):
        self.weights_path = weights_path
        self.model = None

    def load(self):
        self.model = EmotionClassifier()
        self.model.load_state_dict(torch.load(self.weights_path))
        self.model.eval()

    def predict(self, keypoints: np.ndarray) -> EmotionPrediction:
        """
        Args:
            keypoints: Flattened keypoint array (60,) - 20 points Ã— 3 values
        """
        tensor = torch.FloatTensor(keypoints).unsqueeze(0)

        with torch.no_grad():
            logits = self.model(tensor)
            probs = torch.softmax(logits, dim=1)[0]

        class_id = probs.argmax().item()

        return EmotionPrediction(
            class_id=class_id,
            class_name=EMOTION_LABELS[class_id],
            confidence=probs[class_id].item(),
            all_probs={
                EMOTION_LABELS[i]: probs[i].item()
                for i in range(6)
            }
        )
```

---

## Output

- `packages/models/emotion.py`
- `tests/test_models/test_emotion.py`
