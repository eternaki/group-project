# Story 6.2: Single Frame Inference

**Status:** To Do
**Assignee:** U3 (Danylo Zherzdiev)
**Priority:** High
**Sprint:** 6 - Inference Pipeline

---

## Description

As a developer, I want to process single frames through all models.

---

## Acceptance Criteria

- [ ] process_frame() method implemented
- [ ] All 4 models called in correct sequence
- [ ] Cropping between bbox and other models
- [ ] Annotations returned correctly

---

## Tasks

- [ ] Implement model loading
- [ ] Implement bbox detection
- [ ] Implement cropping logic
- [ ] Run breed classification on crop
- [ ] Run keypoints on crop
- [ ] Run emotion on keypoints
- [ ] Combine into Annotation object
- [ ] Write tests

---

## Implementation

```python
def process_frame(self, image: np.ndarray) -> list[Annotation]:
    if not self._models_loaded:
        raise RuntimeError("Call load() first")

    annotations = []

    # Step 1: Detect dogs
    detections = self.bbox_model.predict(image)

    for det in detections:
        # Step 2: Crop dog region
        x, y, w, h = det.bbox
        crop = image[y:y+h, x:x+w]

        # Step 3: Classify breed
        breed = self.breed_model.predict(crop)

        # Step 4: Detect keypoints
        keypoints = self.keypoints_model.predict(crop)

        # Step 5: Classify emotion
        kp_features = keypoints.to_features()
        emotion = self.emotion_model.predict(kp_features)

        # Step 6: Create annotation
        annotations.append(Annotation(
            bbox=det.bbox,
            confidence_bbox=det.confidence,
            breed_id=breed.class_id,
            breed_name=breed.class_name,
            confidence_breed=breed.confidence,
            keypoints=keypoints,
            emotion_id=emotion.class_id,
            emotion_name=emotion.class_name,
            confidence_emotion=emotion.confidence
        ))

    return annotations
```

---

## Output

- `packages/pipeline/inference.py`
- `tests/test_pipeline/test_inference.py`
