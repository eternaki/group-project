# Story 6.3: Video Processing

**Status:** To Do
**Assignee:** U3 (Danylo Zherzdiev)
**Priority:** High
**Sprint:** 6 - Inference Pipeline

---

## Description

As a developer, I want to extract and process frames from videos.

---

## Acceptance Criteria

- [ ] VideoProcessor class implemented
- [ ] Frame extraction at configurable FPS
- [ ] Memory-efficient iteration (generator)
- [ ] Support for MP4 format

---

## Tasks

- [ ] Create VideoProcessor class
- [ ] Implement frame extraction with OpenCV
- [ ] Add FPS sampling logic
- [ ] Make iterator memory-efficient
- [ ] Handle video errors gracefully

---

## Implementation

```python
# packages/pipeline/video.py

import cv2
from pathlib import Path
from typing import Iterator, Tuple
import numpy as np

class VideoProcessor:
    def __init__(self, fps_sample: float = 1.0):
        self.fps_sample = fps_sample

    def extract_frames(
        self,
        video_path: Path
    ) -> Iterator[Tuple[int, np.ndarray]]:
        """
        Extract frames at specified FPS.

        Yields:
            Tuple of (frame_index, frame_rgb)
        """
        cap = cv2.VideoCapture(str(video_path))

        if not cap.isOpened():
            raise ValueError(f"Cannot open video: {video_path}")

        video_fps = cap.get(cv2.CAP_PROP_FPS)
        frame_interval = max(1, int(video_fps / self.fps_sample))

        frame_idx = 0
        try:
            while True:
                ret, frame = cap.read()
                if not ret:
                    break

                if frame_idx % frame_interval == 0:
                    frame_rgb = cv2.cvtColor(frame, cv2.COLOR_BGR2RGB)
                    yield frame_idx, frame_rgb

                frame_idx += 1
        finally:
            cap.release()

    def get_video_info(self, video_path: Path) -> dict:
        """Get video metadata."""
        cap = cv2.VideoCapture(str(video_path))
        info = {
            "fps": cap.get(cv2.CAP_PROP_FPS),
            "frame_count": int(cap.get(cv2.CAP_PROP_FRAME_COUNT)),
            "width": int(cap.get(cv2.CAP_PROP_FRAME_WIDTH)),
            "height": int(cap.get(cv2.CAP_PROP_FRAME_HEIGHT)),
        }
        info["duration"] = info["frame_count"] / info["fps"]
        cap.release()
        return info
```

---

## Output

- `packages/pipeline/video.py`
- `tests/test_pipeline/test_video.py`
