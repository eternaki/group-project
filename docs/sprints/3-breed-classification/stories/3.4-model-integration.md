# Story 3.4: Model Integration

**Status:** Done
**Completed:** 2025-01-16
**Assignee:** U3 (Danylo Zherzdiev)
**Priority:** Medium
**Sprint:** 3 - Breed Classification

---

## Description

As a developer, I want to integrate the breed model into the codebase.

---

## Acceptance Criteria

- [x] BreedModel class implemented
- [x] Breed labels mapping loaded correctly
- [x] Unit tests written and passing
- [x] Documentation updated

---

## Tasks

- [x] Create BreedModel class
- [x] Load breed labels from JSON
- [x] Implement prediction with Top-5 output
- [x] Write unit tests
- [x] Add docstrings

---

## Implementation

```python
# packages/models/breed.py

from dataclasses import dataclass
import json
import numpy as np
import torch
import timm
from torchvision import transforms

@dataclass
class BreedPrediction:
    class_id: int
    class_name: str
    confidence: float
    top5: list[tuple[int, str, float]]

class BreedModel:
    def __init__(self, weights_path: str, labels_path: str):
        self.weights_path = weights_path
        self.labels_path = labels_path
        self.model = None
        self.labels = None
        self.transform = transforms.Compose([
            transforms.ToPILImage(),
            transforms.Resize(256),
            transforms.CenterCrop(224),
            transforms.ToTensor(),
            transforms.Normalize([0.485, 0.456, 0.406], [0.229, 0.224, 0.225])
        ])

    def load(self):
        self.model = timm.create_model('efficientnet_b4', num_classes=50)
        self.model.load_state_dict(torch.load(self.weights_path))
        self.model.eval()

        with open(self.labels_path) as f:
            self.labels = json.load(f)

    def predict(self, image: np.ndarray) -> BreedPrediction:
        tensor = self.transform(image).unsqueeze(0)

        with torch.no_grad():
            logits = self.model(tensor)
            probs = torch.softmax(logits, dim=1)[0]

        top5_idx = torch.topk(probs, 5).indices.tolist()
        top5 = [
            (idx, self.labels[str(idx)], probs[idx].item())
            for idx in top5_idx
        ]

        return BreedPrediction(
            class_id=top5[0][0],
            class_name=top5[0][1],
            confidence=top5[0][2],
            top5=top5
        )
```

---

## Output

- `packages/models/breed.py`
- `packages/models/breeds.json`
- `tests/test_models/test_breed.py`
