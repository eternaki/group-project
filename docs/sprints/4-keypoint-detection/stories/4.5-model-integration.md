# Story 4.5: Model Integration

**Status:** To Do
**Assignee:** U2 (Anton Shkrebela)
**Priority:** Medium
**Sprint:** 4 - Keypoint Detection

---

## Description

As a developer, I want to integrate the keypoint model into the codebase.

---

## Acceptance Criteria

- [ ] KeypointsModel class implemented
- [ ] Keypoint postprocessing (heatmap to coordinates)
- [ ] Unit tests written
- [ ] Documentation updated

---

## Tasks

- [ ] Create KeypointsModel class
- [ ] Implement heatmap to coordinate conversion
- [ ] Add visibility estimation
- [ ] Write unit tests
- [ ] Add docstrings

---

## Implementation

```python
# packages/models/keypoints.py

import numpy as np
import torch

from packages.data.schemas import Keypoints, Keypoint

class KeypointsModel:
    KEYPOINT_NAMES = [
        "left_eye", "right_eye", "nose", ...
    ]

    def __init__(self, weights_path: str):
        self.weights_path = weights_path
        self.model = None

    def load(self):
        # Load HRNet model
        pass

    def predict(self, image: np.ndarray) -> Keypoints:
        # Run inference
        heatmaps = self._inference(image)

        # Convert heatmaps to coordinates
        points = self._heatmap_to_coords(heatmaps)

        return Keypoints(points=points, names=self.KEYPOINT_NAMES)

    def _heatmap_to_coords(self, heatmaps: np.ndarray) -> list[Keypoint]:
        """Convert heatmaps to keypoint coordinates."""
        points = []
        for i, hm in enumerate(heatmaps):
            # Find max location
            y, x = np.unravel_index(np.argmax(hm), hm.shape)
            confidence = hm[y, x]
            visibility = 2 if confidence > 0.5 else 1

            points.append(Keypoint(
                x=float(x),
                y=float(y),
                visibility=visibility
            ))
        return points
```

---

## Output

- `packages/models/keypoints.py`
- `tests/test_models/test_keypoints.py`
